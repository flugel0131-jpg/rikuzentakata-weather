<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é™¸å‰é«˜ç”°å¸‚ æ°—è±¡æ³¨æ„å ±ï¼ˆé™¸ä¸Šé™å®šï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h1>é™¸å‰é«˜ç”°å¸‚ æ°—è±¡æ³¨æ„å ±</h1>

<p><strong>ç›£è¦–å¯¾è±¡</strong></p>
<ul>
<li>é™¸ä¸Šã®å¼·é¢¨æ³¨æ„å ±ï¼ˆç™ºè¡¨ï¼è§£é™¤ï¼‰</li>
<li>ä¹¾ç‡¥æ³¨æ„å ±ï¼ˆç™ºè¡¨ï¼è§£é™¤ï¼‰</li>
</ul>

<button onclick="enableNotify()">ğŸ”” é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<h2>å±¥æ­´</h2>
<ul id="log"></ul>

<script>
let lastStatus = {};

function enableNotify() {
  Notification.requestPermission().then(p => {
    if (p === "granted") {
      alert("é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ");
    }
  });
}

async function checkAlerts() {
  try {
    const res = await fetch("https://api.alert-jp.org/api/v1/alerts?limit=100");
    const data = await res.json();

    data.forEach(a => {
      // åœ°åŸŸåˆ¤å®š
      if (!a.area?.includes("é™¸å‰é«˜ç”°å¸‚")) return;

      // ä¹¾ç‡¥æ³¨æ„å ±ï¼ˆåŒºåˆ†ãªã—ï¼‰
      if (a.type === "ä¹¾ç‡¥æ³¨æ„å ±") {
        notify(a.type, a.status);
      }

      // å¼·é¢¨æ³¨æ„å ±ï¼ˆé™¸ä¸Šé™å®šï¼‰
      if (
        a.type === "å¼·é¢¨æ³¨æ„å ±" &&
        a.areas?.some(ar => ar.includes("é™¸ä¸Š"))
      ) {
        notify("é™¸ä¸Šã®å¼·é¢¨æ³¨æ„å ±", a.status);
      }
    });
  } catch (e) {
    console.error("å–å¾—ã‚¨ãƒ©ãƒ¼", e);
  }
}

function notify(type, status) {
  if (lastStatus[type] === status) return;

  lastStatus[type] = status;

  new Notification(`é™¸å‰é«˜ç”°å¸‚ ${type}`, {
    body: status === "ç™ºè¡¨"
      ? "æ³¨æ„å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸ"
      : "æ³¨æ„å ±ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸ"
  });

  const li = document.createElement("li");
  li.textContent = `${new Date().toLocaleString()} ${type}ï¼š${status}`;
  document.getElementById("log").prepend(li);
}

// ğŸ”” 1åˆ†é–“éš”ï¼ˆWebSocketãªã—æœ€çŸ­ï¼‰
setInterval(checkAlerts, 60000);
checkAlerts();
</script>

</body>
</html>
